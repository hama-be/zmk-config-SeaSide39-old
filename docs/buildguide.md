# ビルドガイド

- [ビルドガイド](#ビルドガイド)
  - [1. 注意事項](#1-注意事項)
    - [1-1. 対応するキーボード](#1-1-対応するキーボード)
    - [1-2. ケースとの干渉](#1-2-ケースとの干渉)
    - [1-3. ZMKファームウェアの使用](#1-3-zmkファームウェアの使用)
    - [1-4. KeyballでできてSeaSideでできないこと](#1-4-keyballでできてseasideでできないこと)
    - [1-5. 組み立ての大変さとLiPoバッテリーの取り扱い](#1-5-組み立ての大変さとlipoバッテリーの取り扱い)
  - [2. 準備](#2-準備)
    - [2-1. キット同梱品確認](#2-1-キット同梱品確認)
    - [2-2. 組立前にお客様自身で準備いただく部品](#2-2-組立前にお客様自身で準備いただく部品)
    - [2-3. 必要な工具](#2-3-必要な工具)
  - [3. 組み立て](#3-組み立て)
    - [3-1. ポゴピンの取り付け（一部）](#3-1-ポゴピンの取り付け一部)
    - [3-2. スイッチの取り付け](#3-2-スイッチの取り付け)
    - [3-3. マイコンの足をカット](#3-3-マイコンの足をカット)
    - [3-4. バッテリーコネクタの取り付け](#3-4-バッテリーコネクタの取り付け)
    - [3-5. コンスルーの取り付け](#3-5-コンスルーの取り付け)
    - [3-6. ポゴピン残りのはんだ付け（右側のみ）](#3-6-ポゴピン残りのはんだ付け右側のみ)
    - [3-7. マイコンのはんだ付け](#3-7-マイコンのはんだ付け)
    - [3-8. トラックボールセンサーのはんだ付け](#3-8-トラックボールセンサーのはんだ付け)
    - [3-9. 組み立て](#3-9-組み立て)
  - [4. ファームウェア](#4-ファームウェア)
    - [4-1. テスト用ファームウェアのダウンロード](#4-1-テスト用ファームウェアのダウンロード)
    - [4-2. テスト用ファームウェアの書き込みとペアリング](#4-2-テスト用ファームウェアの書き込みとペアリング)
    - [4-3. 動作確認](#4-3-動作確認)
    - [4-4. ZMK Studioの活用](#4-4-zmk-studioの活用)
    - [4-5. ZMKファームウェアのカスタマイズとビルド方法](#4-5-zmkファームウェアのカスタマイズとビルド方法)
  - [5. お疲れさまでした](#5-お疲れさまでした)


<a id="1-注意事項"></a>
## 1. 注意事項

**※ 購入前にお読みください**

SeaSide39で無線化を行うにあたり、いくつかの制約や注意事項があります。\
これらの内容をご理解いただいた上でのみ、ご購入をお願いいたします。

<a id="1-1-対応するキーボード"></a>
### 1-1. 対応するキーボード

本キットは私の個人的な「愛用のKeyball39を無線化して使いたい！」という気持ちが出発点にあるため、右手トラックボール版のKeyball39専用に設計されています。\
そのため、現時点では左手トラックボールのKeyball39や、トラックボールの配置を問わずKeyball44およびKeyball61では使用できません。\
右手トラックボール版のKeyball39以外でSeaSide39を使用した場合のあらゆるトラブルに対しては対応が困難であることをご了承ください。

なお、左手トラックボール版やKeyball44、Keyball61も無線化してほしいという要望を数件いただいております。今後開発を進めていきたいと考えてはいますが手元にそれらのキーボードが無く着手が難しい状況ですので、開発用にこれらのキーボードをお貸しいただける方がいらっしゃいましたら、ぜひご連絡いただけると幸いです。\
※ 追記：Keyball44、および左手版のKeyball39についてはお貸しいただけることになりましたので早ければ次回入荷時には対応を予定しております！しかしKeyball61には根本的な設計の違いがあり、SeaSide39の方式だと無線化は難しい可能性が高いです。Keyball61ファンの方には申し訳ないです。。。

<a id="1-2-ケースとの干渉"></a>
### 1-2. ケースとの干渉

SeaSide39は可能な限りKeyball39の資源を再利用したいという思想で設計していますが、どうしても構造上USB端子の位置をPro Microと同じにすることができませんでした。\
ですので、多くのKeyball39用ケースとSeaSide39のUSB端子が干渉してしまうという欠点があります。\
↓過去に作成したKeyball39用ケースの場合
![DSC00409](img/DSC00409.JPG)

対応方法としては以下のいずれかになると思います。参考にしていただき、許容できると感じる方のみご購入をお願いいたします。

- 充電やファームウェアの書き込みを行う際のみケースを外す
  - 手間ではありますが、バッテリー持ちは決して悪くないので現実的な選択肢だと思います。カバーに格納できる200mAhのバッテリーでも1~2週間ほどは充電無しで連続利用が可能です。
- 干渉する箇所を切る・削るなどの加工を行う
  - 加工する際は自己責任でお願いいたします。
- 専用ケースを使う
  - お手持ちのケースを使い続けることにこだわりが少ない方は、SeaSide39専用に設計したケースをお使いいただくことも可能です。底面に最大1000mAhまでの大容量バッテリーを搭載できるケースもありますのでぜひご検討ください。1000mAhのバッテリーを使用した場合、1ヶ月以上は充電無しで連続利用が可能です。

<a id="1-3-zmkファームウェアの使用"></a>
### 1-3. ZMKファームウェアの使用
SeaSide39では、マイコンがPro MicroからXIAO BLEに変更されるため、ファームウェアもQMKからZMKに変更となります。これにより、以下のような使い勝手の変化があることをご了承ください：

- Remap等のGUI上でのキーマップ変更ツールが使用できなくなります
  - SeaSide39はZMK Studioというツールにも対応しており、これを使用すればRemapに近い操作感でキーマップの変更も可能ではありますが、機能に制限があり、より複雑な設定を行う場合は結局ファームウェアを直接編集する必要が出てくることが多いです
- キーマップの変更や複雑な設定の変更にはGitHubを使用したファームウェアのビルドが必要になります
- Bluetoothの接続先の切り替えなど、無線特有の操作方法を覚える必要があります

ZMKファームウェアは比較的新しいファームウェアであるため、QMKと比較すると機能面で一部制限があります。しかし、無線化のメリットを享受するためには必要な変更となりますので、これらの違いを許容いただける方のみご購入をお願いいたします。

なお、ZMKファームウェアのビルドや書き込み方法については後述のビルドガイド内「[4. ファームウェア](#4-ファームウェア)」セクションで詳しく説明します。

<a id="1-4-keyballでできてseasideでできないこと"></a>
### 1-4. KeyballでできてSeaSideでできないこと

キーマップを含むQMKファームウェアでの設定内容はZMKに流用できないため、すべてご自身で同等の設定をし直していただく必要があります。あまりないとは思いますが、ファームウェアの違いにより実現自体できなくなる機能が存在する可能性もありますのでご了承ください。

また、ハードウェア面ではSeaSide39では以下の機能が使用できなくなります。
- RGBLEDは点灯しなくなります
- OLEDディスプレイが使用できなくなります（SeaSide39装着時にOLEDを接続しないでください）
- TRRSケーブルが使用できなくなります（SeaSide39装着時にTRRSケーブルを接続しないでください）
- Keyballのリセットボタンは機能しなくなります

これらの制限は無線化に伴う仕様変更によるものですので、あらかじめご理解いただけますようお願いいたします。

<a id="1-5-組み立ての大変さとlipoバッテリーの取り扱い"></a>
### 1-5. 組み立ての大変さとLiPoバッテリーの取り扱い

無線化という性質上、このキットではLiPoバッテリーを扱います。また、細かいはんだ付け作業も必要となります。\
LiPoバッテリーの取り扱いには多少なりともリスクが伴います。他にもはんだ付け作業のミスによる基板や部品の損傷など、様々なトラブルが発生する可能性があります。\
当キットは個人開発のため、自己責任での組み立てとなること、およびすべてのトラブルに対応しきれない場合があることをご理解ください。

<a id="2-準備"></a>
## 2. 準備

制作を始める前に、まずは必要なものがすべて揃っていることをご確認ください。

<a id="2-1-キット同梱品確認"></a>
### 2-1. キット同梱品確認

| 名前 | 数 | 備考 |
|:-|:-|:-|
| メイン基板右用 | 1枚 | |
| メイン基板左用 | 1枚 | |
| トラックボール用基板 | 1枚 | 省電力化のため置き換え |
| ポゴピン(2ピン) | 3本 | |
| コンスルー(12ピン) | 4本 | |
| トラックボール用センサー(PMW3610DM-SUDU) | 1個 | [データシート](https://www.alldatasheet.jp/datasheet-pdf/pdf/899003/PIXART/PMW3610DM-SUDU.html) |
| トラックボールセンサー用レンズ | 1個 | センサーに同梱されています |
| バッテリー用コネクタ | 2本 | JST 1.25mm 2pin|
| スライドスイッチ | 2個 | |
| マイコンカバー | 2個 | カバーセットを購入した方のみ |
| 専用ケース | 2個 | ケースセットを購入した方のみ |
| 大容量ケース | 2個 | 大容量ケースセットを購入した方のみ |
| 大容量ケース底部パーツ | 2個 | 大容量ケースセットを購入した方のみ |
| M2ネジ 8mm | 6本 | 大容量ケースセットを購入した方のみ |


![714690](img/714690.jpg)

<a id="2-2-組立前にお客様自身で準備いただく部品"></a>
### 2-2. 組立前にお客様自身で準備いただく部品

| 名前 | 数 | 備考 |
|:-|:-|:-|
| マイコン Seeed XIAO BLE nRF52840 | 2個 |  |
| Lipoバッテリー | 2個 | 推奨バッテリーについては後述します |
| バッテリーコネクタ | 2本 | 用意したバッテリーのコネクタがJST 1.25mmでない方のみ |

SeaSide39はamazonで購入できる以下のバッテリーのサイズを基準に設計していますので、以下のバッテリーの購入をおすすめします。どちらも2個入りで、JST 1.25mmコネクタ仕様になっているので付属のコネクタに接続可能です。\
これ以外のバッテリーを使用する場合、JST 1.25mmコネクタ以外のものを仕様するには別途コネクタを用意する必要があるためご注意ください。

200mAh : https://www.amazon.co.jp/dp/B08XJZZMN3 \
マイコンカバーにピッタリ格納できるサイズです。この大きさでも1〜2週間は充電無しで連続利用可能です。

1000mAh : https://www.amazon.co.jp/dp/B098DRP9WX \
大容量ケースにピッタリ格納できるサイズです。この大きさ以下であれば大抵のバッテリーが入るはずですので幅広くお選びいただけます。1000mAhあると、1ヶ月以上は充電無しで連続利用可能です。


<a id="2-3-必要な工具"></a>
### 2-3. 必要な工具

SeaSide39の組み立てには下記の工具が必要です。

| 名前 | 備考 |
|:-|:-|
| はんだごて | 温度調整可能なもの推奨 |
| はんだ | |
| ニッパー|ピンヘッダの切断およびバッテリーコネクタ配線の被覆剥き用 |
| ドライバー ||
| ピンセット ||
| 両面テープ|バッテリー固定用|

<a id="3-組み立て"></a>
## 3. 組み立て

ここからはんだ付け作業に入ります。\
特に断りがない作業は左右の基板で同じ作業をすると読み取ってください。

<a id="3-1-ポゴピンの取り付け（一部）"></a>
### 3-1. ポゴピンの取り付け（一部）

マイコン背面のパッドで信号を受け取るためのポゴピンを取り付けます。
組み立ての都合で、現時点ではまだはんだ付けしない良いピンがあるので注意してください。

1. 写真を参考に、ポゴピンを装着する場所を確認します。右側は２箇所、左側は１箇所です。
![DSC00412](img/DSC00412.JPG)


2. 対象のスルーホールにポゴピンを差し込みます。差し込む基板の面とポゴピンの向きを間違えないように注意してください。ロゴがある面に、段差があり根本まで差し込めないほうのピンを差し込むのが正解です。
![DSC00027](img/DSC00027.JPG)

3. 基板を裏返し、ポゴピンが固定されるようにマスキングテープなどで固定してください。裏面にポゴピンの足が少し飛び出していればOKです。
![DSC00028](img/DSC00028.JPG)

4. この状態でポゴピンの足をはんだ付けします。この時、右側基板のポゴピンの足を１本だけはんだ付けしないでおいてください。はんだ付けせずに残す箇所は画像で確認してください。左側基板はすべてはんだ付けしてOKです。
![DSC00032](img/DSC00032.JPG)


<a id="3-2-スイッチの取り付け"></a>
### 3-2. スイッチの取り付け

電源スイッチを基板に取り付けます。

1. スライドスイッチを基板の表面から差し込み、マスキングテープなどで固定します。この時、できるだけ基板の外側に寄せておくと専用ケースを装着した際にスイッチの操作が少しだけやりやすくなります。
![DSC00034](img/DSC00034.JPG)

2. 裏面からはんだ付けします。スイッチが浮かないように注意してください。
3. 気になる方ははみ出した足をカットしてください。
![DSC00035](img/DSC00035.JPG)


<a id="3-3-マイコンの足をカット"></a>
### 3-3. マイコンの足をカット

後の工程に備え、マイコン（Seeed XIAO BLE nRF52840）のピンを長さをカットします。\
※ この工程は行わなくても組み立て可能です。組み立て済みをご注文いただいた方は、この工程が行われていないものが届く場合がありますのでご了承ください。

1. マイコンに付属のピンヘッダをマイコンにはんだ付けします。画像のようになればOKです。
![DSC00036](img/DSC00036.JPG)
   
2. マイコンの足を基板のスルーホールに差し込みます。差し込む箇所は画像で確認してください。
![DSC00413](img/DSC00413.JPG)

3. ポゴピンが押し込まれ、これ以上差し込めないことを確認したら、その状態でピンのはみ出している部分をニッパーでカットします。この時、完全に長さを合わせずにわずかにはみ出す程度の長さでカットしてください。画像のようになればOKです。
![DSC00046](img/DSC00046.JPG)
  
4. 長さを揃えることができたら、一度マイコンを抜きとります。この時、ギリギリでカットしすぎたりニッパーの質が悪いと、ピンの先端が変形し、マイコンがなかなか基板から抜けない場合があります。その場合は破損しないように注意しながら引き抜いてください。

<a id="3-4-バッテリーコネクタの取り付け"></a>
### 3-4. バッテリーコネクタの取り付け

Lipoバッテリー用のコネクタを取り付けます。

1. バッテリーコネクタを任意の長さに切断します。長さは基本的に好みですが、長すぎてもケーブルの取り回しが難しくなることがあるので2~3センチメートル程度を推奨します。
2. ケーブルの被覆を2mmほど剥きます。ニッパーやカッターで剥けますが、ケーブルが細く慣れていないとケーブル自体を切断してしまうこともあるので、先程切ったケーブルの切れ端で練習してから挑むことをおすすめします。
![DSC00048](img/DSC00048.JPG)

3. 基板の裏面からバッテリー端子用のスルーホールにはんだ付けします。この時、BAT+に赤色、BAT-に黒色を接続します。必ず間違えないように確認してください。バッテリーをマイコンカバーに格納する予定の方は画像の通り（基板下側向き）に、大容量ケースに格納する予定の方は逆方向（基板上側向き）にはんだ付けしたほうが少しだけケーブルが取り回しやすくなります。迷ったら画像の向きではんだ付けすればOKです。
![DSC00049](img/DSC00049.JPG)
  組み立て済の場合、すべて下向きではんだ付けしてあります。

<a id="3-5-コンスルーの取り付け"></a>
### 3-5. コンスルーの取り付け

マイコンを装着するためのコンスルーピンを取り付けます。

1. Keyball39基板のOLEDとPro Microを取り外します。キーキャップやキースイッチなども取り外しておいたほうが作業性がよくなります。
2. コンスルーピンをKeyball基板の表面に差し込みます。差し込む穴は画像を参照してください。特に左側は、本家KeyballでPro Microを差し込んでいた場所と異なりますので注意が必要です。また、この時コンスルーピンには正しい向きがありますので、[本家Keyballのビルドガイド](https://github.com/Yowkees/keyball/blob/main/keyball39/doc/rev1/buildguide_jp.md#3-6promicro%E3%81%AE%E3%81%AF%E3%82%93%E3%81%A0%E4%BB%98%E3%81%91)を参考に差し込む向きもご確認ください。

![DSC00414](img/DSC00414.JPG)
![DSC00054](img/DSC00054.JPG)

1. コンスルーピンを差し込んだら、その上からSeaSide39基板の基板を差し込みます。この時に、右側基板ではんだ付けせずに残して置いたポゴピンの足が干渉し隙間が空きやすいので、色々な角度から隙間を覗き、コンスルーを基板の間に隙間がないことをしっかりとご確認ください。

  以下の部分が特に隙間が空きやすいので注意。最悪隙間があっても動作に問題はないので、基板の傾きが気にならない方は神経質にならずに作業を進めてもOKです。
  ![DSC00062](img/DSC00062.JPG)


4. 隙間が無いことを確認したらコンスルーピンをはんだ付けして固定します。この時、はんだを盛りすぎるとマイコンを装着する際に干渉する場合があるので、少量のはんだで軽く接着するようなイメージではんだ付けを行ってください。コンスルーピンははんだ付けしなくても電気的に導通するので、ポゴピンやマイコン用のスルーホールと干渉するリスクのあるピン（画像赤枠のあたり）については無理にはんだ付けをする必要はありません。あくまでコンスルーが抜けてしまわないように固定するためにはんだ付けを行いますので、最悪四隅のピンだけでもはんだ付けできていればOKです。
![DSC00058](img/DSC00058.JPG)



<a id="3-6-ポゴピン残りのはんだ付け（右側のみ）"></a>
### 3-6. ポゴピン残りのはんだ付け（右側のみ）

右側基板ではんだ付けせずに残して置いたポゴピンの足をはんだ付けします。

1. SeaSide39基板をKeyball39基板から外します。
2. 右側基板裏側の、はんだ付けがされていないピンにはんだ付けをします。コンスルーが干渉しているので、溶かしてしまわないようにだけ注意しながら短時間の加熱・少量のはんだでさっとはんだ付けを行います。
![DSC00063](img/DSC00063.JPG)

<a id="3-7-マイコンのはんだ付け"></a>
### 3-7. マイコンのはんだ付け

Seeed XIAO BLE nRF52840を基板に取り付けます。

1. マイコンを基板のスルーホールに差し込みます。コンスルーがスルーホールに少し干渉しているので刺さりにくいことがありますが、慎重かつ力強く押し込むとなんとかなるはずです。もしかするとここが一番の難所かもしれません。
![DSC00064](img/DSC00064.JPG)
2. 差し込んだマイコンによってポゴピンの先端が押し込まれていることを確認します。
3. 差し込んだマイコンとSeaSide39基板が平行になるように傾きを微調整します。
![012153818](img/012153818.jpg)
4. 先ほどのポゴピンの足と同様に、こちらもコンスルーと干渉していますので溶かしてしまわないよう注意しつつ、さっとはんだ付けをします。
5. 画像のようになればOKです。
![DSC00065](img/DSC00065.JPG)

マイコンの足をカットしなかった場合は以下のような仕上がりになります。
![232758465](img/232758465.jpg)


<a id="3-8-トラックボールセンサーのはんだ付け"></a>
### 3-8. トラックボールセンサーのはんだ付け

省電力タイプのトラックボール読み取りセンサーを基板に取り付けます。

1. センサーを基板に差し込みます。画像を参考に、向きを間違えないようにしてください。
![DSC00072](img/DSC00072.JPG)
2. すべてのピンにはんだ付けをし、センサーの保護シールを剥がします。はんだ付けの際に、はんだごてが表面実装の部品に触れてしまわないよう注意してください。
![DSC00076](img/DSC00076.JPG)
3. センサー用レンズを差し込みます。画像を参考に、向きを間違えないようにしてください。
![DSC00077](img/DSC00077.JPG)

以上ではんだ付けは完了です。お疲れさまでした！\
スライドスイッチをオン（左側）に入れ、USBケーブルを繋ぐと充電インジケータが緑色に光り、充電されていることが確認できるはずです。バッテリーの充電はスイッチをオンにしている時にしか行われないのでご注意ください。

![DSC00067](img/DSC00067.JPG)


<a id="3-9-組み立て"></a>
### 3-9. 組み立て

ここまでの作業でSeaSide39の主要部分の組み立ては完了しました。最後にKeyball39基板への装着とカバーおよびケース（オプションパーツ）の取り付けを行います。購入されたパーツに応じて必要な作業だけを行ってください。また、作業中はSeaSide39のスイッチをオフ（右側）にしたままにしておいてください。

1. バッテリーコネクタの向きを確認します。大容量ケースを使用しない方は、コネクタケーブルを基板下側へ向け、大容量ケースを使用する方は基板上側に向けます。大容量ケースを使用する、かつ下向きにコネクタをはんだ付けした方は、画像のようにコネクタケーブルを曲げて基板上側に向けます。
  このとき、ケーブルの根本に負荷がかかると断線するおそれがあるので優しく取り扱ってください。
  ![DSC00456](img/DSC00456.JPG)
  
1. SeaSide39をKeyball39基板に装着します。差し込む穴は画像の通りです。
  ![DSC00414](img/DSC00414.JPG)
  大容量ケースを使用しない方は、画像のようにOLED用のピンソケットを避けるように隙間を通してください。ソケットと基板でケーブルを挟みこんでしまわないように注意します。
  ![DSC00455](img/DSC00455.JPG)
  大容量ケースを使用する方は、Keyball39基板の底面側に出るようにケーブルを通してください。
  ![DSC00457](img/DSC00457.JPG)

1. バッテリーを装着します。  大容量ケースを使用しない方は、マイコンカバーの裏面に両面テープで200mAhバッテリーを固定しコネクタを接続します。画像を参考に、組み立てた時にXIAO BLEと干渉しないように位置決めをしてください。
  ![DSC00458](img/DSC00458.JPG)
  ケーブルがはみ出さないように注意しつつ、隙間に押し込みながらカバーをネジ止めします。
  ![DSC00459](img/DSC00459.JPG)
  写真のようにUSBコネクタとカバーの位置が合っていればOKです。
  ![DSC00460](img/DSC00460.JPG)
  大容量ケースを使用する方は、バッテリーを接続する前にケースを装着する必要があります。画像のようにコネクタを穴から下に出し、赤く囲ったネジだけ（右側2箇所、左側1箇所）を固定します。
  ![DSC00461](img/DSC00461.JPG)
  大容量ケースの底面パーツにバッテリーを両面テープで固定し、コネクタを接続します。
  ![DSC00462](img/DSC00462.JPG)
  ケーブルがはみ出さないように注意しつつ、隙間に押し込みながらカバーを閉じます。
  ![DSC00463](img/DSC00463.JPG)
  残りのネジを締めます。底面パーツのネジ止めは、大容量ケースに付属の8mmネジを使用します。写真のように隙間が空いていなければOKです。
  ![DSC00464](img/DSC00464.JPG)
  専用ケースおよび大容量ケースどちらの場合も、画像のようにコネクタとスイッチが位置がケースに合っていることを確認してください。
  ![DSC00441](img/DSC00441.JPG)

1. トラックボール読み取り基板を元のKeyball39のものからSeaSide39のものに置き換えます。Keyball39のものとほぼ同じサイズになっているので、元の状態と同じように基板を差し替えるだけでOKです。
![DSC00077](img/DSC00077.JPG)
3. 基板の差し替えが済んだら、トラックボールケースを元通りに装着しケースに固定します。

<a id="4-ファームウェア"></a>
## 4. ファームウェア

<a id="4-1-テスト用ファームウェアのダウンロード"></a>
### 4-1. テスト用ファームウェアのダウンロード

まずはテスト用のファームウェアを書き込み、動作確認を行います。以下のリンクからファームウェアをダウンロードしてください。

| 名前 | 用途 | リンク |
|:-|:-|:-|
| Seaside39_L rgbled_adapter-seeeduino_xiao_ble-zmk.uf2 | 左側用ファームウェア | [ダウンロード]( test_firmware/Seaside39_L%20rgbled_adapter-seeeduino_xiao_ble-zmk.uf2) |
| Seaside39_R rgbled_adapter-seeeduino_xiao_ble-zmk.uf2  | 右側用ファームウェア | [ダウンロード](test_firmware/Seaside39_R%20rgbled_adapter-seeeduino_xiao_ble-zmk.uf2) |
| settings_reset-seeeduino_xiao_ble-zmk.uf2 | リセット用ファームウェア | [ダウンロード](test_firmware/settings_reset-seeeduino_xiao_ble-zmk.uf2) |

<a id="4-2-テスト用ファームウェアの書き込みとペアリング"></a>
### 4-2. テスト用ファームウェアの書き込みとペアリング

マイコンにファームウェアを書き込みます。テスト用といいつつ通常動作するファームウェアなので、この工程が済むと一旦の完成になります。\
しかしながら高確率で今後自分だけのファームウェア設定を模索していくことになると思いますので、テスト用ではない本番のファームウェアはぜひ皆さんの手で作り上げてください。

1. SeaSide39のスイッチがオフ（右側）になっていることを確認します。
2. マイコンをブートローダーモードにします。
   - PCとSeaSide39（左）をUSBケーブルで接続します。
   - マイコンのリセットボタンを素早く2回押します。専用カバーの場合、ふたつ空いているうちに左側がリセットスイッチ用の穴です。爪楊枝などで押し込んでください。ボタンが小さいので穴越しに2回押すのは最初少し難しいかもしれません。（何回かやればすぐ慣れます）
   - PC上で「XIAO SENSE」というドライブが認識されれば成功です。
3. 「XIAO SENSE」ドライブに `settings_reset-seeeduino_xiao_ble-zmk.uf2` をドラッグ&ドロップまたはコピー&ペーストで書き込みます。この時、macの場合画像のようなメッセージが出る場合がありますが、「XIAO SENSE」ドライブが自動的に認識されなくなっていたら書き込みに成功しています。
   `settings_reset-seeeduino_xiao_ble-zmk.uf2` は設定初期化用のファイルなので、基本的に以後ファームウェアの書き換えを行う際などには書き込み不要です。
!
4. 再度マイコンをブートローダーモードにし、今度は `Seaside39_L rgbled_adapter-seeeduino_xiao_ble-zmk.uf2` を同様の手順で書き込みます。この時も同様のメッセージが出ることがありますが、正常です。
5. SeaSide39の右側にも同様の手順で`settings_reset-seeeduino_xiao_ble-zmk.uf2` → `Seaside39_R rgbled_adapter-seeeduino_xiao_ble-zmk.uf2` の順番で書き込みを行います。
6. 左右の書き込みが完了したらUSBケーブルを取り外し、両方のSeaSide39のスイッチをオン（左側）にし、左→右の順番でマイコンのリセットスイッチを一度ずつ押します
7. 電源オンの時やリセットの時にマイコンのLEDが点滅するはずです。専用カバーの場合右側の穴がLED確認用の穴です。以下の意味がありますので、正常に点滅することを確認してください。
   - 最初の点灯（バッテリーの残量）
     - 🟢/🟡/🔴の三段階で点灯。SeaSide39の場合は40%以上は🟢、20%までは🟡、それ以下は🔴が点灯するように設定されています。
     - この閾値はファームウェアを編集することでお好みに設定できます。
   - 2つ目の点灯（ブルートゥースの接続状況）
      - 🔵は接続成功、🟡はペアリング中、🔴は接続失敗を意味します。
      - 左右で少し意味が異なり、左側の点灯は親側（右側）へのペアリング状況を意味し、右側の点灯はPCなどの機器へのペアリング状況を意味します。
  - ですので、ファームウェア書き込み後の正常な点灯は以下のとおりです。
    - 左側：🟢/🟡/🔴（バッテリーの充電状況次第）→ 🔵（右側との接続成功）
    - 右側：🟢/🟡/🔴（バッテリーの充電状況次第）→ 🟡（機器とのペアリング中）
  
  詳細は[zmk-rgbled-widget](https://github.com/caksoylar/zmk-rgbled-widget)のREADMEをご覧ください。
8. 正常に点灯していたらPC側で「SeaSide39」に接続してください。
9. 複数の端末とのペアリングを行いたい場合は接続切り替えキー`BT_SEL *`を使用します。デフォルトキーマップだとレイヤー6のZ~Bのキー（5台分）に割当てています。切り替えキーを押すたびにLEDが先述の「２つ目の点灯」パターンを示します。未使用のペアリングキーを選択 → 黄色点灯（ペアリング中）を確認 → 使用したい端末でペアリング操作 という流れになります。接続をやり直したりリセットしたい場合は`BT_CLR`や`BT_CLR_ALL`キーを使用してください。

<a id="4-3-動作確認"></a>
### 4-3. 動作確認

Bluetoothの接続後、キーやトラックボールの動作を確認してください。\
初回起動時、稀にトラックボールが一時的に反応しないことがあります。電源をいれたまま10分ほど待ってみて、反応がなければリセットスイッチや電源のオンオフ、トラックボール読み取り基板の抜き差しなどを試してみてください。それでもトラックボールが反応しない場合は組み立てのミスやセンサーの故障が疑われますので、ご連絡いただけますと可能な範囲でサポートいたします。（注意事項にも記載したとおり、すべてにサポートしきれない可能性があることはご了承ください。）

<a id="4-4-zmk-studioの活用"></a>
### 4-4. ZMK Studioの活用

[注意事項](#1-3-zmkファームウェアの使用)で説明したとおり、ZMK Studioを使用することでファームウェアを書き換えることなくGUIでキーマップを簡単に編集できます。\
Remapなどに近い操作感で設定が可能ですが、機能に一部制限があります。そもそもまだ開発段階？のようです。なのでZMK Studioでのカスタマイズのみでは後々物足りなくなる可能性が高いですが、GitHubに慣れていない方などはまずはこちらでいろいろ触ってみるのも手だと思います。

1. [ZMK Studio](https://zmk.studio/)にアクセスします。
2. 接続するキーボード（SeaSide39）を選択します。
3. 接続が完了すると、現在のキーマップが表示されます。
4. 変更したいキーをクリックし、任意の動作を選択します。
5. 設定が完了したら右上の保存ボタンをクリックして変更を保存します。
   
細かい操作や設定、どういった制限があるのかなどについてはここでは説明しませんので詳しくは[こちら](http://zmk.dev/docs/features/studio)を参照してください。

<a id="4-5-zmkファームウェアのカスタマイズとビルド方法"></a>
### 4-5. ZMKファームウェアのカスタマイズとビルド方法

ZMK Studioで対応していない高度な設定を行いたい場合は、直接ファームウェアをカスタマイズしてビルドする必要があります。ファームウェアのカスタマイズビルドにはGitHubを使用します。\
おおまかなフローは以下のとおりです。ここでは各ツールの細かな使い方の説明はしませんので、必要に応じて調べてみてください。
![flow](img/flow.jpg)

1. このリポジトリ([hama-be/zmk-config-Seaside39](https://github.com/hama-be/zmk-config-Seaside39))をフォークする
  - あなたのGitHubアカウント上にzmk-config-Seaside39が表示されていればOKです。
2. 手動またはKeymapEditorでファームウェアを編集する
  - [ZMK Keymap Editor](https://nickcoutsos.github.io/keymap-editor/) とあなたのGitHubアカウントを接続すると、KeymapEditorから直接リポジトリへ変更をプッシュすることができます。
  - キーマップ以外の各種設定値などを変更する場合はファイルを直接編集しプッシュしてください。好みに応じて編集するであろう設定は以下の箇所です。特にオートマウスレイヤを使用するかどうかは非常に好みの分かれるところなのではないでしょうか。
    - `config/boards/shields/Seaside39/Seaside39_R.conf`
    ```
    # トラックボールの感度設定（値が高いほど感度が高くなる）
    CONFIG_PMW3610_CPI=600
    # オートマウスレイヤー有効時、マウスレイヤーが無効化されるまでの時間（ミリ秒）
    CONFIG_PMW3610_AUTOMOUSE_TIMEOUT_MS=600

    # 電源オン時のLEDインジケータの有効/無効
    CONFIG_RGBLED_WIDGET=y 
    # バッテリー残量が40%未満の時黄色、20%未満の時赤色表
    CONFIG_RGBLED_WIDGET_BATTERY_LEVEL_HIGH=40    
    CONFIG_RGBLED_WIDGET_BATTERY_LEVEL_CRITICAL=20 

    # レイヤー切り替え時のLEDインジケータの有効/無効
    CONFIG_RGBLED_WIDGET_SHOW_LAYER_COLORS=y

    # レイヤーごとの色設定（0=オフ, 1=赤, 2=緑, 3=黄, 4=青, 5=マゼンタ, 6=シアン, 7=白
    # オートマウスレイヤーだけ青色に光り、それ以外のレイヤーはオフに設定
    CONFIG_RGBLED_WIDGET_LAYER_0_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_1_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_2_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_3_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_4_COLOR=4
    CONFIG_RGBLED_WIDGET_LAYER_5_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_6_COLOR=0
    CONFIG_RGBLED_WIDGET_LAYER_7_COLOR=0
    ```    
  - `config/boards/shields/Seaside39/Seaside39_R.overlay`
    ```
    trackball: trackball@0 {
        status = "okay";
        compatible = "pixart,pmw3610";
        reg = <0>;
        spi-max-frequency = <2000000>;
        irq-gpios = <&gpio0 4 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        automouse-layer = <4>; //ここをコメントアウトするとオートマウスレイヤーがオフになる
        scroll-layers = <5>; 
    };
    ```
3. ビルドされたファームウェアをダウンロードして書き込む
  - 「GitHub Actions」という機能を使って、コードをプッシュするたびに自動的にファームウェアがビルドされます。
  - Actionsはリポジトリの「Actions」タブから確認できます。初回は手動で有効化が必要です。
  - リポジトリに変更をプッシュすると数分でビルドが完了します。「Actions」タブから最新のワークフローを開き、Artifactsからファームウェアをダウンロードしてください。
    ![build](img/build.png)
  - ダウンロードしたファームウェアを書き込みます。キーマップの変更の場合は右側だけの書き込みでOKです。


ZMKファームウェアについて、細かくカスタマイズをしたい方は[ZMK公式ドキュメント](https://zmk.dev/docs/)を参照してください。


 
<a id="5-お疲れさまでした"></a>
## 5. お疲れさまでした

これにて組み立ては完了です。お疲れさまでした！\
ぜひ使用感やご意見ご要望、便利なファームウェアやキーマップのセッティングなど、何でも良いので `#SeaSide39` をつけて共有いただけると嬉しいです。見に行きます！\
それでは、良き無線Keyballライフをお過ごしください☺️